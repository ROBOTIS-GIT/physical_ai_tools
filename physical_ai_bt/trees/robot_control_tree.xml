<?xml version="1.0"?>
<!--
  Behavior Tree for Robot Control with VLA Inference and Rule-based Movement

  Architecture:
  1. Wait for AI Server to start inference independently
  2. Monitor inference state via /task/status topic
  3. Maintain inference for specified duration (default 5s)
  4. Send FINISH command to AI Server to stop inference
  5. Wait 0.5s for AI Server cleanup
  6. Execute rule-based movement to fixed target position

  Topics:
  - Subscribe: /task/status (TaskStatus) - Monitor AI Server inference state
  - Subscribe: /follower/joint_states (JointState) - Monitor robot position
  - Publish: /leader/joint_trajectory (JointTrajectory) - Control robot movement

  Services:
  - /task/command (SendCommand) - Control AI Server inference
-->
<root main_tree_to_execute="RobotControlSequence">
    <BehaviorTree ID="RobotControlSequence">
        <Sequence name="RobotControlSequence">
            <!--
              InferenceAction:
              - Detects when AI Server starts inference (phase == INFERENCING)
              - Monitors for specified timeout duration
              - Sends FINISH command to stop inference
              - Waits 2.0s for cleanup before completing
            -->
            <InferenceAction name="VLA_Inference"
                             timeout="{inference_timeout}"/>

            <!--
              RuleAction:
              - Publishes fixed trajectory to /leader/joint_trajectory
              - Monitors /joint_states for position feedback
              - Completes when target position reached within threshold
              - joint_names: Injected from config at runtime
            -->
            <RuleAction name="Rule_Based_Movement"
                        timeout="{rule_timeout}"
                        current_positions="{current_positions}"
                        target_positions="{target_positions}"
                        position_threshold="{position_threshold}"/>
        </Sequence>
    </BehaviorTree>

    <!-- Node Definitions -->
    <TreeNodesModel>
        <!-- Control Nodes -->
        <Control ID="Sequence">
            <description>
                Execute children sequentially.
                If any child returns FAILURE, stop and return FAILURE.
                If any child returns RUNNING, return RUNNING.
                If all children return SUCCESS, return SUCCESS.
            </description>
        </Control>

        <Control ID="Fallback">
            <description>
                Execute children sequentially until one succeeds.
                If any child returns SUCCESS, stop and return SUCCESS.
                If any child returns RUNNING, return RUNNING.
                If all children return FAILURE, return FAILURE.
            </description>
        </Control>

        <!-- Action Nodes -->
        <Action ID="InferenceAction">
            <input_port name="timeout" default="5.0">
                Duration in seconds to maintain inference before stopping.
                After timeout, sends FINISH command to AI Server.
            </input_port>
            <description>
                Monitors AI Server status and manages VLA inference lifecycle.

                States:
                1. RUNNING - Waiting for inference to start
                2. RUNNING - Monitoring inference duration
                3. RUNNING - Waiting for cleanup (0.5s after FINISH)
                4. SUCCESS - Inference completed and stopped

                Uses /task/status to detect inference (phase == INFERENCING),
                then sends FINISH command via /task/command after timeout.
            </description>
        </Action>

        <Action ID="RuleAction">
            <input_port name="current_positions" default="">
                Starting joint positions (comma-separated floats).
                Used for initialization only.
            </input_port>
            <input_port name="target_positions" default="">
                Target joint positions (comma-separated floats).
                Must match number of joints in joint_names.
            </input_port>
            <input_port name="joint_names" default="">
                Joint names (comma-separated strings).
                Loaded from physical_ai_server config's joint_order.
            </input_port>
            <input_port name="position_threshold" default="0.1">
                Position error threshold (radians) to consider target reached.
            </input_port>
            <input_port name="timeout" default="15.0">
                Maximum time (seconds) to reach target before returning FAILURE.
            </input_port>
            <description>
                Moves robot to fixed target positions using trajectory control.

                States:
                1. RUNNING - Trajectory command sent, waiting for completion
                2. SUCCESS - Target reached (all joints within threshold)
                3. FAILURE - Timeout or invalid joint configuration

                Publishes JointTrajectory to /leader/joint_trajectory,
                monitors /follower/joint_states for position feedback.
            </description>
        </Action>
    </TreeNodesModel>
</root>
