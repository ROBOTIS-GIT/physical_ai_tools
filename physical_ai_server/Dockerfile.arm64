FROM robotis/ros:jazzy-ros-base-torch2.7.0-cuda12.8.0 AS physical-ai-tools

RUN echo 'export PATH=/opt/venv/bin:$PATH' >> /root/.bashrc && \
    echo 'export PYTHONPATH=/opt/venv/lib/python3.12/site-packages:$PYTHONPATH' >> /root/.bashrc && \
    export PATH=/opt/venv/bin:$PATH && \
    export PYTHONPATH=/opt/venv/lib/python3.12/site-packages:$PYTHONPATH;

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive

# Install realsense and physical_ai_tools dependencies
RUN apt-get update && apt-get install -y \
    ffmpeg \
    vim \
    nano \
    && rm -rf /var/lib/apt/lists/*

ENV COLCON_WS=/root/ros2_ws
WORKDIR ${COLCON_WS}

RUN mkdir -p ${COLCON_WS}/src && \
    cd ${COLCON_WS}/src && \
    git clone -b jazzy https://github.com/ROBOTIS-GIT/physical_ai_tools.git --recursive

RUN cd ${COLCON_WS} && \
    apt-get update && \
    rosdep update && \
    rosdep install -i --from-path src --rosdistro $ROS_DISTRO -y && \
    rm -rf /var/lib/apt/lists/*

RUN cd ${COLCON_WS}/src/physical_ai_tools/lerobot && \
    sed -i '/"torch[^\"]*",/d' pyproject.toml && \
    sed -i '/"torchvision[^\"]*",/d' pyproject.toml && \
    pip install --index-url https://pypi.jetson-ai-lab.io/jp6/cu126/+simple --extra-index-url https://pypi.org/simple --ignore-installed -e .

RUN cd ${COLCON_WS}/src/physical_ai_tools/lerobot && \
    pip install --index-url https://pypi.jetson-ai-lab.io/jp6/cu126/+simple --extra-index-url https://pypi.org/simple -e ".[smolvla]"

RUN pip install --index-url https://pypi.jetson-ai-lab.io/jp6/cu126/+simple --extra-index-url https://pypi.org/simple setuptools==68.1.2
RUN pip install --index-url https://pypi.jetson-ai-lab.io/jp6/cu126/+simple --extra-index-url https://pypi.org/simple 'numpy<2'

RUN echo 'export PYTHONPATH=${COLCON_WS}/src/physical_ai_tools/lerobot/src:$PYTHONPATH' >> /root/.bashrc && \
    export PYTHONPATH=${COLCON_WS}/src/physical_ai_tools/lerobot/src:$PYTHONPATH;

RUN bash -c "source /opt/ros/${ROS_DISTRO}/setup.bash && \
    cd ${COLCON_WS} && \
    colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release"

RUN echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> ~/.bashrc  && \
    echo "source ${COLCON_WS}/install/setup.bash" >> ~/.bashrc  && \
    echo "alias cb='colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release'" >> ~/.bashrc && \
    echo "alias ai_server='ros2 launch physical_ai_server physical_ai_server_bringup.launch.py'" >> ~/.bashrc && \
    echo "export ROS_DOMAIN_ID=30" >> ~/.bashrc
